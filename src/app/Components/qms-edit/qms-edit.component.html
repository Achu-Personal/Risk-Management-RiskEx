<div class="qmsForm">
  <form [formGroup]="qmsForm" (ngSubmit)="onSubmit()">
    <div class="form-details-sub-container">
      <h2>Risk Details</h2>
      <div class="form-row">
        <app-form-input
          label="Risk Category"
          required=" *"
          formControlName="riskName"
          (infoClicked)="toggleModalCategory()"
        ></app-form-input>
        @if(qmsForm.get("riskName")){ @if
        (qmsForm.get("riskName")?.hasError('required')&&
        qmsForm.get("riskName")?.dirty) {
        <div class="text-danger">Risk Category is required</div>
        } }
        @if(preSelectedProject ==null){
          <div class="dropdown-header">
            <p [ngStyle]="{
              'margin-top': '18px',
              'margin-left': '18px',
              'font-style': 'italic',
              color: 'grey'
            }">No project for this risk</p>
          </div>

       }

        @if(preSelectedProject !==null){
          <div class="readonly-dropdown">
            <app-form-dropdown
            label="Project Name"
            dropdownCode="projectCode"
            [dropdownData]="dropdownProject"
            dropdownDisplay="name"
            dropdownValue="id"
            selectValue="Select project"
            [selectedValue]="preSelectedProject"
            (change)="onDropdownChangeProject($event)"
            [openDropdownId]="openDropdownId"
            (openDropdown)="handleDropdownOpen($event)"
            dropdownId="projectDropdown"
          ></app-form-dropdown>
        </div>

        }
      </div>
      <!-- @if(isAdmin === 'Admin'){
      <app-form-dropdown
        label="Department Name"
        [dropdownData]="dropdownDepartment"
        dropdownDisplay="departmentName"
        dropdownValue="id"
        selectValue="Select department"
        (change)="onDropdownChangeDepartment($event)"
        [openDropdownId]="openDropdownId"
        (openDropdown)="handleDropdownOpen($event)"
      ></app-form-dropdown>
      } -->
      <app-form-text-area
        label="Impact Of Risk"
        required="*"
        placeHolder="Enter impact of risk"
        message="Impact of a risk refers to the potential consequences or effects that a risk event
      may have on a project, system, or organization if it occurs. It can include financial loss,
      delays, operational disruptions, or damage to reputation."
        formControlName="impact"
        backgroundColor=" var(--form-color)"
      ></app-form-text-area>

      @if(qmsForm.get("impact")){ @if
      (qmsForm.get("impact")?.hasError('maxlength')) {
      <div class="text-danger">maximum length is 1000</div>

      } @else if (qmsForm.get("impact")?.hasError('minlength')) {
      <div class="text-danger">minimum length is 15</div>

      } @else if (qmsForm.get("impact")?.hasError('required')&&
      qmsForm.get("impact")?.dirty) {
      <div class="text-danger">Impact of risk is required</div>
      } }

      <app-form-text-area
        label="Description"
        required="*"
        placeHolder="Enter description of risk"
        message="Provide a detailed description of the risk, including what could cause it"
        formControlName="description"
        backgroundColor=" var(--form-color)"
      ></app-form-text-area>

      @if(qmsForm.get("description")){ @if
      (qmsForm.get("description")?.hasError('maxlength')) {
      <div class="text-danger">maximum length is 1000</div>

      } @else if (qmsForm.get("description")?.hasError('minlength')) {
      <div class="text-danger">minimum length is 15</div>

      } @else if (qmsForm.get("description")?.hasError('required')&&
      qmsForm.get("description")?.dirty) {
      <div class="text-danger">Description of risk is required</div>
      } }
    </div>
    <div class="form-details-sub-container">
      <h2>Current Risk Assessment</h2>
      <div class="form-row">
        <app-form-dropdown
          label="Likelihood"
          required="*"
          message="Click to view Likelihood table"
          (infoClicked)="handleInfoClickLikelihood($event)"
          backgroundColor=" var(--form-color)"
          [showInfoButtonLikeliHoodImpact]="true"



          [dropdownData]="dropdownLikelihood"
          dropdownDisplay="assessmentFactor"
          dropdownValue="id"
          selectValue="Select likelihood"
          (change)="onDropdownChangelikelihood($event)"
          [selectedValue]="preSelectedLikelihood"
          [openDropdownId]="openDropdownId"
          (openDropdown)="handleDropdownOpen($event)"
        ></app-form-dropdown>

        <app-form-dropdown
          label="Impact"
          required="*"
          [dropdownData]="dropdownImpact"
          dropdownDisplay="assessmentFactor"
          dropdownValue="id"
          selectValue="Select impact"
          (change)="onDropdownChangeImpact($event)"
          [selectedValue]="preSelectedImpact"
          [openDropdownId]="openDropdownId"
          (openDropdown)="handleDropdownOpen($event)"
          (infoClicked)="handleInfoClickImpact($event)"
          message="Click to view Impact table"
          backgroundColor=" var(--form-color)"
        [showInfoButtonLikeliHoodImpact]="true"

        ></app-form-dropdown>
      </div>
      <div class="form-row" [ngStyle]="{ gap: '32vw', 'margin-top': '30px' }">
        <h2 [ngStyle]="{ 'border-bottom': '0px', 'text-transform': 'none' }">
          Risk Factor :<span style="margin-left: 10px">{{ riskFactor }}</span>
        </h2>
        <h2
          [ngStyle]="{
            'border-bottom': '0px',
            'text-transform': 'none',
            'margin-left': '-37%'
          }"
        >
          Overall Risk Rating :<span
            style="margin-left: 10px"
            [ngStyle]="{ color: changeColorOverallRiskRating() }"
          >
            {{ overallRiskRating }}</span
          >
        </h2>
      </div>
      <p
        [ngStyle]="{
          'margin-top': '20px',
          'font-style': 'italic',
          color: 'grey'
        }"
      >
        Risk factor = Likelihood * Impact
      </p>

      <p
        [ngStyle]="{
          'margin-top': '20px',
          'font-style': 'italic',
          color: 'grey'
        }"
      >
        Overall risk rating = Likelihood * Impact
      </p>
      <div
        [ngStyle]="{
          'margin-top': '20px',
          'font-style': 'italic',
          color: 'grey'
        }"
      >
        <p>
          For more reference
          <span (click)="isHeatMapReference()"
            ><a href="javascript:void(0);">click </a></span
          >
          here
        </p>
      </div>
    </div>
    <div class="form-details-sub-container">
      <h2>Risk Management</h2>
      <app-form-text-area
        label="Risk Mitigation"
        required="*"
        placeHolder="Enter mitigation plan"
        message="Mitigation refers to actions taken to reduce the likelihood or impact of a risk.
      Ensure preventive measures, such as implementing safety protocols or backup systems, to minimize
      the risk."
        formControlName="mitigation"
        backgroundColor=" var(--form-color)"
      ></app-form-text-area>

      @if(qmsForm.get("mitigation")){ @if
      (qmsForm.get("mitigation")?.hasError('maxlength')) {
      <div class="text-danger">maximum length is 1000</div>

      } @else if (qmsForm.get("mitigation")?.hasError('minlength')) {
      <div class="text-danger">minimum length is 15</div>

      } @else if (qmsForm.get("mitigation")?.hasError('required')&&
      qmsForm.get("mitigation")?.dirty) {
      <div class="text-danger">Mitigation of risk is required</div>
      } }

      <app-form-text-area
        label="Risk Contingency"
        placeHolder="Enter contingency plan"
        message="Contingency planning involves preparing for unforeseen events by having backup
      plans in place. These plans help ensure that your project can continue with minimal disruption
      if unexpected risks occur."
        formControlName="contingency"
        backgroundColor=" var(--form-color)"
      ></app-form-text-area>
    </div>
    <div class="form-details-sub-container">
      <h2>Action Plan</h2>
      @if(!isnewAssigneenameDisplay){
      <app-form-dropdown
        label="Risk Owner"
        required="*"
        [dropdownData]="dropdownAssignee"
        dropdownDisplay="fullName"
        dropdownValue="id"
        selectValue="Select responsible person"
        (change)="onDropdownChangeResponsiblePerson($event)"
        [selectedValue]="preSelectedResponsiblePerson"
        [openDropdownId]="openDropdownId"
        (openDropdown)="handleDropdownOpen($event)"
        message="You can select an existing responsible person from the dropdown
      or enter a new one. If you enter a new name, it will take priority over the dropdown selection."
        [showInfoButton]="true"
        backgroundColor=" var(--form-color)"
      ></app-form-dropdown>
      }

      @if(isnewAssigneenameDisplay){
        <h6
          style="
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--foreground-color);
          "
        >
          Responsibility of action <span style="color: red">*</span>
        </h6>
        <div
          style="
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
          "
        >
          <span>{{ newAssigneename }}</span>
        </div>
        }




      <div
        [ngStyle]="{
          'margin-top': '20px',
          'font-style': 'italic',
          color: 'grey'
        }"
      >
        <p>
          If responsible person not in the list
          <span (click)="isAssigneeNotInList()"
            ><a href="javascript:void(0);">click </a></span
          >here
        </p>
      </div>

      <app-form-date-field
        label="Planned Action Date"
        required="*"
        formControlName="plannedActionDate"
      ></app-form-date-field>

      @if(qmsForm.get("plannedActionDate")){ @if
      (qmsForm.get("plannedActionDate")?.hasError('required')&&
      qmsForm.get("plannedActionDate")?.dirty) {
      <div class="text-danger">planned action date is required</div>
      } }
    </div>
    <div class="form-details-sub-container">
      <h2>Reviewer</h2>
      @if(!isnewReviewernameDisplay){
      <app-form-dropdown
        label="Reviewer"
        required="*"
        [dropdownData]="dropdownReviewer"
        dropdownDisplay="fullName"
        dropdownValue="fullName"
        selectValue="Select reviewer"
        (change)="onDropdownChangeReviewer($event)"
        [selectedValue]="preSelectedReviewer"
        [openDropdownId]="openDropdownId"
        (openDropdown)="handleDropdownOpen($event)"
        message="You can select an existing reviewer from the dropdown
      or enter a new one. If you enter a new name, it will take priority over the dropdown selection."
        [showInfoButton]="true"
        backgroundColor=" var(--form-color)"
      ></app-form-dropdown>
      }

      @if(isnewReviewernameDisplay){
        <h6
          style="
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--foreground-color);
          "
        >
          Reviewer <span style="color: red">*</span>
        </h6>
        <div
          style="
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            background-color: #f9f9f9;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%;
          "
        >
          <span>{{ newReviewername }}</span>
        </div>
        }



      <div
        [ngStyle]="{
          'margin-top': '20px',
          'font-style': 'italic',
          color: 'grey'
        }"
      >
        <p>
          If reviewer not in the list
          <span (click)="isReviewerNotInList()"
            ><a href="javascript:void(0);">click </a></span
          >here
        </p>
      </div>
    </div>
    <div class="form-details-sub-container">
      <div class="button-group">
        <app-style-button
          (clicked)="saveConfirmation()"
          label="Submit"
          type="button"
        ></app-style-button>
        <app-style-button
          (clicked)="cancelRisk()"
          label="Cancel"
          type="button"
        ></app-style-button>
      </div>
    </div>
  </form>
  @if(HeatMapRefernce){
  <h5>For Reference</h5>
  <app-form-reference-heatmap-popup
    (closeHeatMap)="closeHeatMap()"
  ></app-form-reference-heatmap-popup>
  } @if(isLoading) {
  <app-form-loader></app-form-loader>> }
  @if(assigneeNotInList){

    <!-- @if(isAdmin=="Admin"){
      <app-form-data-not-in-list
        placeholder="Enter responsible person name"
        [isAssignee]="true"
        [assigneeDepartment]="departmentIdForAdminToAddToString"
        textLabel="Responsible person name"
        [dropdownDepartment]="dropdownDepartment"
        (cancelForm)="receiveCancel($event)"
        (sendData)="saveAssignee($event)"
        [openDropdownId]="openDropdownId"
        (openDropdown)="handleDropdownOpen($event)"
      ></app-form-data-not-in-list>
      } -->

      <!-- @if(isAdmin!=="Admin"){ -->
        <app-form-data-not-in-list
        placeholder="Enter responsible person name"
        [isAssignee]="true"
        [assigneeDepartment]="departmentidForAssignee"
        textLabel="Responsible person name"
        [dropdownDepartment]="dropdownDepartment"
        (cancelForm)="receiveCancel($event)"
        (sendData)="saveAssignee($event)"
        [openDropdownId]="openDropdownId"
        (openDropdown)="handleDropdownOpen($event)"
      ></app-form-data-not-in-list>
      <!-- } -->

  }
  @if(reviewerNotInList){
  <app-form-data-not-in-list
    placeholder="Enter reviewer name"
    [isAssignee]="false"
    textLabel="Reviewer name"
    [dropdownDepartment]="dropdownDepartment"
    (cancelForm)="receiveCancel($event)"
    (sendData)="saveReviewer($event)"
    [openDropdownId]="openDropdownId"
    (openDropdown)="handleDropdownOpen($event)"
  ></app-form-data-not-in-list>
  } @if(isSuccessReviewer){
  <app-form-successfull
    message="The new Reviewer has been added successfully!"
    [isSuccessfull]="true"
    (closeDialog)="closeReviewer()"
  >
  </app-form-successfull>
  } @if(isErrorReviewer){
  <app-form-successfull
    message="Something went wrong! <br> Please ensure all required fields are filled in correctly and check your internet connection.<br> If the issue persists, try again later or contact support."
    [isSuccessfull]="false"
    (closeDialog)="closeReviewer()"
  >
  </app-form-successfull>
  } @if(isSuccessAssignee){
  <app-form-successfull
    message="The new Assignee has been added successfully!"
    [isSuccessfull]="true"
    (closeDialog)="closeAssignee()"
  >
  </app-form-successfull>
  } @if(isErrorAssignee){
  <app-form-successfull
    message="Something went wrong! <br> Please ensure all required fields are filled in correctly and check your internet connection.<br> If the issue persists, try again later or contact support."
    [isSuccessfull]="false"
    (closeDialog)="closeAssignee()"
  >
  </app-form-successfull>
  } @if(isSave){
  <app-form-conform-popup
    message="Do you want to save the entered risk details? <br> You can check and edit them later if needed."
    (closeDialog)="saveRisk()"
    (notCloseDialog)="saveConfirmation()"
  ></app-form-conform-popup>
  } @if(isCancel){
  <app-form-conform-popup
    message="Are you sure you want to cancel? <br> Any unsaved changes will be lost."
    (closeDialog)="closeRisk()"
    (notCloseDialog)="cancelRisk()"
  ></app-form-conform-popup>
  } @if(isValid){
  <app-form-successfull
    message="Please check the form fields and <br> ensure all mandatory fields are satisfied "
    [isSuccessfull]="false"
    (closeDialog)="closepopupIsValidCheck()"
  >
  </app-form-successfull>
  }

  @if(showModalCategory){
    <app-form-category-table (closeModalEvent)="closeModalCategory()"></app-form-category-table>
  }

  @if(showModal){
    <app-form-likelihood-impact-tooltip [showModal]="showModal" [tableType]="tableType" (closeRiskModal)="hideModal()"></app-form-likelihood-impact-tooltip>
  }
</div>
